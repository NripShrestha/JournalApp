@page "/journal"
@using JournalApp.Models
@inject JournalApp.Data.AppDatabase Database

<div class="journal-container">
    <div class="journal-grid">

        <!-- ================= HISTORY ================= -->
        <aside class="history-section">
            <h2 class="section-title">Journal History</h2>

            <div class="history-scroll">
                @if (entries.Count == 0)
                {
                    <div class="empty-state">No entries yet.</div>
                }
                else
                {
                    @foreach (var entry in entries)
                    {
                        <div class="history-card"
                             @key="entry.Id"
                             @onclick="() => EditEntry(entry)"
                             style="cursor: pointer;">

                            <div class="card-pills">
                                <span class="badge-pill pill-date">
                                    @entry.CreatedAt.ToString("MMM dd")
                                </span>

                                @if (entryTags.TryGetValue(entry.Id, out var tags))
                                {
                                    foreach (var tag in tags)
                                    {
                                        <span class="badge-pill pill-tag">@tag.Name</span>
                                    }
                                }

                                @if (entryMoods.TryGetValue(entry.Id, out var moods))
                                {
                                    foreach (var mood in moods)
                                    {
                                        <span class="badge-pill pill-mood">@mood.Name</span>
                                    }
                                }
                            </div>

                            <h4 class="card-title">@entry.Title</h4>

                            <p class="card-excerpt">
                                @(entry.Content.Length > 100
                                    ? entry.Content.Substring(0, 100) + "..."
                                    : entry.Content)
                            </p>

                            <!-- DELETE BUTTON -->
                            <button type="button"
                                    class="card-delete"
                                    @onclick="async () => await DeleteEntry(entry)"
                                    @onclick:stopPropagation>
                                <i class="bi bi-trash"></i>
                            </button>

                        </div>
                    }
                }
            </div>
        </aside>

        <!-- ================= EDITOR ================= -->
        <main class="editor-section">
            <div class="editor-card">

                <div class="input-row">
                    <label class="editor-label">Title:</label>
                    <input type="text"
                           class="title-input"
                           @bind="entryTitle" />
                </div>

                <div class="selection-row">
                    <div class="selection-label">
                        <i class="bi bi-emoji-smile"></i> <span>Mood:</span>
                    </div>
                    <div class="pill-cloud">
                        @foreach (var mood in allMoods)
                        {
                            <button type="button"
                                    class="selection-pill @(selectedPrimaryMoodId == mood.Id ? "active" : "")"
                                    @onclick="() => selectedPrimaryMoodId = mood.Id">
                                <span class="dot"></span> @mood.Name
                            </button>
                        }
                    </div>
                </div>

                <div class="selection-row">
                    <div class="selection-label">
                        <span>Secondary Mood:</span>
                    </div>
                    <div class="pill-cloud">
                        @foreach (var mood in allMoods)
                        {
                            var isDisabled = !selectedSecondaryMoodIds.Contains(mood.Id)
                                && selectedSecondaryMoodIds.Count >= 2;

                            <button type="button"
                                    class="selection-pill @(selectedSecondaryMoodIds.Contains(mood.Id) ? "active" : "") @(isDisabled ? "disabled" : "")"
                                    disabled="@isDisabled"
                                    @onclick="() => ToggleSecondaryMood(mood.Id, !selectedSecondaryMoodIds.Contains(mood.Id))">
                                <span class="dot"></span> @mood.Name
                            </button>
                        }
                    </div>
                </div>

                <div class="selection-row">
                    <div class="selection-label">
                        <i class="bi bi-tags"></i> <span>Tags:</span>
                    </div>
                    <div class="pill-cloud">
                        @foreach (var tag in allTags)
                        {
                            <button type="button"
                                    class="selection-pill @(selectedTagIds.Contains(tag.Id) ? "active" : "")"
                                    @onclick="() => ToggleTag(tag.Id, !selectedTagIds.Contains(tag.Id))">
                                <span class="dot"></span> @tag.Name
                            </button>
                        }
                    </div>
                </div>

                <div class="textarea-container">
                    <textarea placeholder="Add description"
                              @bind="entryContent"></textarea>
                </div>

                <div class="action-footer">
                    <button type="button"
                            class="btn-entry"
                            @onclick="SaveTodayEntry">
                        @(editingEntry != null ? "Update Entry" : "Create Entry")
                    </button>

                    @if (editingEntry != null)
                    {
                        <button type="button"
                                class="btn-entry"
                                style="background-color: #6c757d; margin-left: 10px;"
                                @onclick="ClearForm">
                            Cancel
                        </button>
                    }
                </div>

            </div>
        </main>

    </div>
</div>

@code {
    private string entryTitle = string.Empty;
    private string entryContent = string.Empty;

    // Track which entry we're editing
    private JournalEntry? editingEntry = null;

    private List<JournalEntry> entries = new();
    private List<Tag> allTags = new();
    private List<Mood> allMoods = new();

    private int selectedPrimaryMoodId;
    private List<int> selectedSecondaryMoodIds = new();
    private List<int> selectedTagIds = new();

    private Dictionary<int, List<Tag>> entryTags = new();
    private Dictionary<int, List<Mood>> entryMoods = new();

    protected override async Task OnInitializedAsync()
    {
        allTags = await Database.GetTagsAsync();
        allMoods = await Database.GetMoodsAsync();
        await LoadEntries();
    }

    private async Task LoadEntries()
    {
        entries = await Database.GetEntriesAsync();

        entryTags.Clear();
        entryMoods.Clear();

        foreach (var entry in entries)
        {
            entryTags[entry.Id] = await Database.GetTagsForEntryAsync(entry.Id);
            entryMoods[entry.Id] = await Database.GetMoodsForEntryAsync(entry.Id);
        }
    }

    // Load entry for editing
    private async Task EditEntry(JournalEntry entry)
    {
        editingEntry = entry;
        entryTitle = entry.Title;
        entryContent = entry.Content;

        // Load tags
        var tags = await Database.GetTagsForEntryAsync(entry.Id);
        selectedTagIds = tags.Select(t => t.Id).ToList();

        // Get the actual primary mood from database
        var moodLinks = await Database.GetMoodLinksForEntryAsync(entry.Id);
        var primaryLink = moodLinks.FirstOrDefault(ml => ml.IsPrimary);

        selectedPrimaryMoodId = primaryLink?.MoodId ?? 0;
        selectedSecondaryMoodIds = moodLinks
            .Where(ml => !ml.IsPrimary)
            .Select(ml => ml.MoodId)
            .ToList();
    }

    // Handles both create and update
    private async Task SaveTodayEntry()
    {
        if (editingEntry != null)
        {
            // UPDATE existing entry
            editingEntry.Title = entryTitle;
            editingEntry.Content = entryContent;
            editingEntry.UpdatedAt = DateTime.Now;

            await Database.UpdateEntryAsync(editingEntry);

            // Update tags and moods
            await Database.SaveEntryTagsAsync(editingEntry.Id, selectedTagIds);

            if (selectedPrimaryMoodId != 0)
            {
                await Database.SaveEntryMoodsAsync(
                    editingEntry.Id,
                    selectedPrimaryMoodId,
                    selectedSecondaryMoodIds
                );
            }
        }
        else
        {
            // CREATE new entry
            var today = DateTime.Today;

            await Database.SaveEntryAsync(new JournalEntry
            {
                Title = entryTitle,
                Content = entryContent,
                EntryDate = today
            });

            var savedEntry = await Database.GetEntryByDateAsync(today);

            if (savedEntry != null)
            {
                await Database.SaveEntryTagsAsync(savedEntry.Id, selectedTagIds);

                if (selectedPrimaryMoodId != 0)
                {
                    await Database.SaveEntryMoodsAsync(
                        savedEntry.Id,
                        selectedPrimaryMoodId,
                        selectedSecondaryMoodIds
                    );
                }
            }
        }

        // Clear form
        ClearForm();
        await LoadEntries();
    }

    // Clear form helper
    private void ClearForm()
    {
        editingEntry = null;
        entryTitle = string.Empty;
        entryContent = string.Empty;
        selectedPrimaryMoodId = 0;
        selectedSecondaryMoodIds.Clear();
        selectedTagIds.Clear();
    }

    private void ToggleSecondaryMood(int moodId, bool isChecked)
    {
        if (isChecked)
        {
            if (!selectedSecondaryMoodIds.Contains(moodId)
                && selectedSecondaryMoodIds.Count < 2)
            {
                selectedSecondaryMoodIds.Add(moodId);
            }
        }
        else
        {
            selectedSecondaryMoodIds.Remove(moodId);
        }
    }

    private void ToggleTag(int tagId, bool isChecked)
    {
        if (isChecked)
        {
            if (!selectedTagIds.Contains(tagId))
                selectedTagIds.Add(tagId);
        }
        else
        {
            selectedTagIds.Remove(tagId);
        }
    }

    private async Task DeleteEntry(JournalEntry entry)
    {
        // If we're editing this entry, clear the form
        if (editingEntry?.Id == entry.Id)
        {
            ClearForm();
        }

        await Database.DeleteEntryAsync(entry);
        await LoadEntries();
    }
}