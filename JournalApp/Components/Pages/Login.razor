@page "/login"
@inject SecurityService Security
@inject NavigationManager Nav

<div class="auth-container">
    <div class="auth-card">
        <div class="auth-header">
            <div class="logo-section">
                <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
            </div>
            <h1 class="auth-title">Welcome Back</h1>
            <p class="auth-subtitle">@username</p>
        </div>

        <div class="auth-form">
            <div class="form-group">
                <label class="form-label">
                    <i class="bi bi-lock"></i>
                    Enter Your PIN
                </label>
                <input type="password"
                       maxlength="4"
                       inputmode="numeric"
                       pattern="[0-9]*"
                       class="form-input pin-input-field"
                       placeholder="••••"
                       @bind="pin"
                       @bind:event="oninput"
                       @onkeyup="HandleKeyUp"
                       autofocus />
            </div>

            @if (!string.IsNullOrEmpty(error))
            {
                <div class="error-message">
                    <i class="bi bi-exclamation-circle"></i>
                    @error
                </div>
            }

            <button class="auth-button" @onclick="HandleLogin">
                Unlock
            </button>

            <button class="auth-link-button" @onclick="GoToForgotPin">
                <i class="bi bi-question-circle"></i>
                Forgot PIN?
            </button>
        </div>
    </div>
</div>

@code {
    private string username = "";
    private string pin = "";
    private string error = "";

    protected override async Task OnInitializedAsync()
    {
        username = await Security.GetUsernameAsync();
        
        // If no setup exists, redirect to setup
        if (string.IsNullOrEmpty(username))
        {
            Nav.NavigateTo("/setup");
        }
    }

    private async Task HandleKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await HandleLogin();
    }

    private async Task HandleLogin()
    {
        error = "";

        if (pin.Length != 4)
        {
            error = "PIN must be 4 digits";
            return;
        }

        if (await Security.VerifyPinAsync(pin))
        {
            Nav.NavigateTo("/");
        }
        else
        {
            error = "Incorrect PIN";
            pin = "";
        }
    }

    private void GoToForgotPin()
    {
        Nav.NavigateTo("/forgot-pin");
    }
}