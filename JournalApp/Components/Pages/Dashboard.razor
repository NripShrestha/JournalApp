@page "/dashboard"
@using JournalApp.Models
@inject JournalApp.Data.AppDatabase Database
@inject IJSRuntime JSRuntime

<div class="moods-container">
    <h1 class="page-title">Mood Tracking & Analytics</h1>

    <!-- Date Range Filter -->
    <div class="filter-section">
        <h3>Filter by Date Range</h3>
        <div class="date-filters">
            <div class="filter-group">
                <label>Start Date:</label>
                <input type="date" @bind="startDate" />
            </div>
            <div class="filter-group">
                <label>End Date:</label>
                <input type="date" @bind="endDate" />
            </div>
            <button class="btn-filter" @onclick="ApplyFilters">Apply</button>
            <button class="btn-filter" @onclick="ClearFilters">Clear</button>
        </div>
    </div>

    <!-- Analytics Dashboard -->
    <div class="analytics-section">
        <h2>Mood Analytics</h2>

        <div class="stats-grid">
            <!-- Most Frequent Mood -->
            <div class="stat-card">
                <h4>Most Frequent Mood</h4>
                @if (mostFrequentMood != null)
                {
                    <div class="mood-badge @GetMoodCategoryClass(mostFrequentMood.Category)">
                        @mostFrequentMood.Name
                    </div>
                    <p class="category-label">(@mostFrequentMood.Category)</p>
                }
                else
                {
                    <p>No data available</p>
                }
            </div>

            <!-- Mood Distribution Pie Chart -->
            <div class="stat-card distribution-card">
                <h4>Mood Category Distribution</h4>
                @if (moodDistribution != null && moodDistribution.Values.Sum() > 0)
                {
                    <div class="pie-chart-container">
                        <canvas id="moodPieChart"></canvas>
                    </div>
                }
                else
                {
                    <p>No mood data available</p>
                }
            </div>
        </div>
    </div>

    <!-- Mood History by Category -->
    <div class="history-section">
        <h2>Mood History</h2>

        @if (entries == null)
        {
            <p>Loading mood history...</p>
        }
        else if (entries.Count == 0)
        {
            <p class="empty-message">No entries found for the selected date range.</p>
        }
        else
        {
            @foreach (var category in new[] { "Positive", "Neutral", "Negative" })
            {
                var categoryEntries = GetEntriesByCategory(category);

                if (categoryEntries.Any())
                {
                    <div class="category-section">
                        <h3 class="category-header @GetCategoryHeaderClass(category)">
                            <span class="@GetCategoryIconClass(category)"></span>
                            @category Moods (@categoryEntries.Count)
                        </h3>

                        <div class="entry-grid">
                            @foreach (var entry in categoryEntries)
                            {
                                <div class="mood-entry-card">
                                    <div class="entry-date">
                                        @entry.EntryDate.ToString("MMM dd, yyyy")
                                    </div>
                                    <div class="entry-title">
                                        @entry.Title
                                    </div>
                                    <div class="mood-pills">
                                        @if (entryMoods.TryGetValue(entry.Id, out var moods) && moods.Any())
                                        {
                                            var primaryMood = moods.FirstOrDefault(m =>
                                            entryMoodLinks.TryGetValue(entry.Id, out var links) &&
                                            links.Any(l => l.MoodId == m.Id && l.IsPrimary));

                                            var secondaryMoods = moods.Where(m => m != primaryMood).ToList();

                                            @if (primaryMood != null)
                                            {
                                                <span class="mood-pill primary-mood @GetMoodCategoryClass(primaryMood.Category)">
                                                    ★ @primaryMood.Name
                                                </span>
                                            }

                                            @foreach (var mood in secondaryMoods)
                                            {
                                                <span class="mood-pill secondary-mood @GetMoodCategoryClass(mood.Category)">
                                                    @mood.Name
                                                </span>
                                            }
                                        }
                                        else
                                        {
                                            <span class="no-mood">No mood recorded</span>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
            }
        }
    </div>
</div>

@code {
    private List<JournalEntry>? entries;
    private Dictionary<int, List<Mood>> entryMoods = new();
    private Dictionary<int, List<JournalEntryMood>> entryMoodLinks = new();

    private Dictionary<string, int>? moodDistribution;
    private Mood? mostFrequentMood;

    private DateTime? startDate;
    private DateTime? endDate;

    protected override async Task OnInitializedAsync()
    {
        await LoadMoodData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (moodDistribution != null && moodDistribution.Values.Sum() > 0)
        {
            await RenderPieChart();
        }
    }

    private async Task LoadMoodData()
    {
        // Load entries (with date filter if applied)
        if (startDate.HasValue || endDate.HasValue)
        {
            entries = await Database.GetEntriesFilteredAsync(startDate, endDate);
        }
        else
        {
            entries = await Database.GetEntriesAsync();
        }

        // Load moods and mood links for each entry
        entryMoods.Clear();
        entryMoodLinks.Clear();

        foreach (var entry in entries)
        {
            entryMoods[entry.Id] = await Database.GetMoodsForEntryAsync(entry.Id);
            entryMoodLinks[entry.Id] = await Database.GetMoodLinksForEntryAsync(entry.Id);
        }

        // Load analytics
        moodDistribution = await Database.GetMoodCategoryDistributionAsync(startDate, endDate);
        mostFrequentMood = await Database.GetMostFrequentMoodAsync(startDate, endDate);
    }

    private async Task RenderPieChart()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("dashboardCharts.renderMoodPie", moodDistribution);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error rendering chart: {ex.Message}");
        }
    }

    private async Task ApplyFilters()
    {
        await LoadMoodData();
        await RenderPieChart();
    }

    private async Task ClearFilters()
    {
        startDate = null;
        endDate = null;
        await LoadMoodData();
        await RenderPieChart();
    }

    private List<JournalEntry> GetEntriesByCategory(string category)
    {
        if (entries == null) return new List<JournalEntry>();

        var result = new List<JournalEntry>();

        foreach (var entry in entries)
        {
            if (entryMoods.TryGetValue(entry.Id, out var moods))
            {
                // Check if any primary mood matches the category
                if (entryMoodLinks.TryGetValue(entry.Id, out var links))
                {
                    var primaryMoodLink = links.FirstOrDefault(l => l.IsPrimary);
                    if (primaryMoodLink != null)
                    {
                        var primaryMood = moods.FirstOrDefault(m => m.Id == primaryMoodLink.MoodId);
                        if (primaryMood?.Category == category)
                        {
                            result.Add(entry);
                        }
                    }
                }
            }
        }

        return result.OrderByDescending(e => e.EntryDate).ToList();
    }

    private string GetMoodCategoryClass(string category)
    {
        return category.ToLower() switch
        {
            "positive" => "mood-positive",
            "neutral" => "mood-neutral",
            "negative" => "mood-negative",
            _ => ""
        };
    }

    private string GetCategoryHeaderClass(string category)
    {
        return $"category-header-{category.ToLower()}";
    }

    private string GetCategoryIconClass(string category)
    {
        return category.ToLower() switch
        {
            "positive" => "bi bi-emoji-smile",
            "neutral" => "bi bi-emoji-neutral",
            "negative" => "bi bi-emoji-frown",
            _ => "bi bi-circle"
        };
    }
}