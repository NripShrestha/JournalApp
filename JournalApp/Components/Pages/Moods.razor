@page "/moods"
@using JournalApp.Models
@inject JournalApp.Data.AppDatabase Database

<div class="moods-container">
    <h1 class="page-title">Mood Tracking & Analytics</h1>

    <!-- Date Range Filter -->
    <div class="filter-section">
        <h3>Filter by Date Range</h3>
        <div class="date-filters">
            <div class="filter-group">
                <label>Start Date:</label>
                <input type="date" @bind="startDate" />
            </div>
            <div class="filter-group">
                <label>End Date:</label>
                <input type="date" @bind="endDate" />
            </div>
            <button class="btn-filter" @onclick="ApplyFilters">Apply</button>
            <button class="btn-filter" @onclick="ClearFilters">Clear</button>
        </div>
    </div>

    <!-- Analytics Dashboard -->
    <div class="analytics-section">
        <h2>Mood Analytics</h2>

        <div class="stats-grid">
            <!-- Most Frequent Mood -->
            <div class="stat-card">
                <h4>Most Frequent Mood</h4>
                @if (mostFrequentMood != null)
                {
                    <div class="mood-badge @GetMoodCategoryClass(mostFrequentMood.Category)">
                        @mostFrequentMood.Name
                    </div>
                    <p class="category-label">(@mostFrequentMood.Category)</p>
                }
                else
                {
                    <p>No data available</p>
                }
            </div>

            <!-- Mood Distribution -->
            <div class="stat-card distribution-card">
                <h4>Mood Category Distribution</h4>
                @if (moodDistribution != null && moodDistribution.Values.Sum() > 0)
                {
                    <div class="distribution-bars">
                        @foreach (var category in new[] { "Positive", "Neutral", "Negative" })
                        {
                            var count = moodDistribution.ContainsKey(category) ? moodDistribution[category] : 0;
                            var total = moodDistribution.Values.Sum();
                            var percentage = total > 0 ? (count * 100.0 / total) : 0;

                            <div class="bar-item">
                                <div class="bar-label">
                                    <span class="@GetCategoryIconClass(category)"></span>
                                    <span>@category</span>
                                </div>
                                <div class="bar-container">
                                    <div class="bar-fill @GetBarColorClass(category)"
                                         style="width: @percentage%"></div>
                                    <span class="bar-text">@count (@percentage.ToString("F1")%)</span>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p>No mood data available</p>
                }
            </div>
        </div>
    </div>

    <!-- Mood History by Category -->
    <div class="history-section">
        <h2>Mood History</h2>

        @if (entries == null)
        {
            <p>Loading mood history...</p>
        }
        else if (entries.Count == 0)
        {
            <p class="empty-message">No entries found for the selected date range.</p>
        }
        else
        {
            @foreach (var category in new[] { "Positive", "Neutral", "Negative" })
            {
                var categoryEntries = GetEntriesByCategory(category);

                if (categoryEntries.Any())
                {
                    <div class="category-section">
                        <h3 class="category-header @GetCategoryHeaderClass(category)">
                            <span class="@GetCategoryIconClass(category)"></span>
                            @category Moods (@categoryEntries.Count)
                        </h3>

                        <div class="entry-grid">
                            @foreach (var entry in categoryEntries)
                            {
                                <div class="mood-entry-card">
                                    <div class="entry-date">
                                        @entry.EntryDate.ToString("MMM dd, yyyy")
                                    </div>
                                    <div class="entry-title">
                                        @entry.Title
                                    </div>
                                    <div class="mood-pills">
                                        @if (entryMoods.TryGetValue(entry.Id, out var moods) && moods.Any())
                                        {
                                            var primaryMood = moods.FirstOrDefault(m =>
                                            entryMoodLinks.TryGetValue(entry.Id, out var links) &&
                                            links.Any(l => l.MoodId == m.Id && l.IsPrimary));

                                            var secondaryMoods = moods.Where(m => m != primaryMood).ToList();

                                            @if (primaryMood != null)
                                            {
                                                <span class="mood-pill primary-mood @GetMoodCategoryClass(primaryMood.Category)">
                                                    ★ @primaryMood.Name
                                                </span>
                                            }

                                            @foreach (var mood in secondaryMoods)
                                            {
                                                <span class="mood-pill secondary-mood @GetMoodCategoryClass(mood.Category)">
                                                    @mood.Name
                                                </span>
                                            }
                                        }
                                        else
                                        {
                                            <span class="no-mood">No mood recorded</span>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
            }
        }
    </div>
</div>

<style>
    .moods-container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }

    .page-title {
        font-size: 32px;
        font-weight: bold;
        margin-bottom: 30px;
        color: #333;
    }

    /* Filter Section */
    .filter-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }

        .filter-section h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #555;
        }

    .date-filters {
        display: flex;
        gap: 15px;
        align-items: flex-end;
        flex-wrap: wrap;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

        .filter-group label {
            font-size: 14px;
            color: #666;
        }

        .filter-group input[type="date"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

    .btn-filter {
        padding: 8px 20px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }

        .btn-filter:hover {
            background: #0056b3;
        }

    /* Analytics Section */
    .analytics-section {
        margin-bottom: 40px;
    }

        .analytics-section h2 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #333;
        }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

        .stat-card h4 {
            margin: 0 0 15px 0;
            color: #555;
            font-size: 16px;
        }

    .mood-badge {
        display: inline-block;
        padding: 10px 20px;
        border-radius: 20px;
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .category-label {
        color: #888;
        font-size: 14px;
        margin: 5px 0 0 0;
    }

    /* Distribution Bars */
    .distribution-bars {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .bar-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .bar-label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 600;
        color: #555;
    }

    .bar-container {
        position: relative;
        background: #f0f0f0;
        border-radius: 10px;
        height: 30px;
        overflow: hidden;
    }

    .bar-fill {
        height: 100%;
        border-radius: 10px;
        transition: width 0.3s ease;
    }

    .bar-text {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 12px;
        font-weight: bold;
        color: #333;
    }

    .bar-positive {
        background: #4caf50;
    }

    .bar-neutral {
        background: #ff9800;
    }

    .bar-negative {
        background: #f44336;
    }

    /* History Section */
    .history-section {
        margin-top: 40px;
    }

        .history-section h2 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #333;
        }

    .category-section {
        margin-bottom: 35px;
    }

    .category-header {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 15px;
        border-radius: 8px;
        font-size: 20px;
        margin-bottom: 15px;
    }

    .category-header-positive {
        background: #e8f5e9;
        color: #2e7d32;
    }

    .category-header-neutral {
        background: #fff3e0;
        color: #e65100;
    }

    .category-header-negative {
        background: #ffebee;
        color: #c62828;
    }

    .entry-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 15px;
    }

    .mood-entry-card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }

        .mood-entry-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

    .entry-date {
        font-size: 12px;
        color: #888;
        margin-bottom: 8px;
    }

    .entry-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 12px;
        color: #333;
    }

    .mood-pills {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }

    .mood-pill {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    .primary-mood {
        font-weight: bold;
        border: 2px solid currentColor;
    }

    .secondary-mood {
        opacity: 0.85;
    }

    .no-mood {
        color: #999;
        font-style: italic;
        font-size: 12px;
    }

    /* Mood Category Colors */
    .mood-positive {
        background: #e8f5e9;
        color: #2e7d32;
    }

    .mood-neutral {
        background: #fff3e0;
        color: #e65100;
    }

    .mood-negative {
        background: #ffebee;
        color: #c62828;
    }

    .empty-message {
        text-align: center;
        color: #999;
        padding: 40px;
        font-size: 16px;
    }
</style>

@code {
    private List<JournalEntry>? entries;
    private Dictionary<int, List<Mood>> entryMoods = new();
    private Dictionary<int, List<JournalEntryMood>> entryMoodLinks = new();

    private Dictionary<string, int>? moodDistribution;
    private Mood? mostFrequentMood;

    private DateTime? startDate;
    private DateTime? endDate;

    protected override async Task OnInitializedAsync()
    {
        await LoadMoodData();
    }

    private async Task LoadMoodData()
    {
        // Load entries (with date filter if applied)
        if (startDate.HasValue || endDate.HasValue)
        {
            entries = await Database.GetEntriesFilteredAsync(startDate, endDate);
        }
        else
        {
            entries = await Database.GetEntriesAsync();
        }

        // Load moods and mood links for each entry
        entryMoods.Clear();
        entryMoodLinks.Clear();

        foreach (var entry in entries)
        {
            entryMoods[entry.Id] = await Database.GetMoodsForEntryAsync(entry.Id);
            entryMoodLinks[entry.Id] = await Database.GetMoodLinksForEntryAsync(entry.Id);
        }

        // Load analytics
        moodDistribution = await Database.GetMoodCategoryDistributionAsync(startDate, endDate);
        mostFrequentMood = await Database.GetMostFrequentMoodAsync(startDate, endDate);
    }

    private async Task ApplyFilters()
    {
        await LoadMoodData();
    }

    private async Task ClearFilters()
    {
        startDate = null;
        endDate = null;
        await LoadMoodData();
    }

    private List<JournalEntry> GetEntriesByCategory(string category)
    {
        if (entries == null) return new List<JournalEntry>();

        var result = new List<JournalEntry>();

        foreach (var entry in entries)
        {
            if (entryMoods.TryGetValue(entry.Id, out var moods))
            {
                // Check if any primary mood matches the category
                if (entryMoodLinks.TryGetValue(entry.Id, out var links))
                {
                    var primaryMoodLink = links.FirstOrDefault(l => l.IsPrimary);
                    if (primaryMoodLink != null)
                    {
                        var primaryMood = moods.FirstOrDefault(m => m.Id == primaryMoodLink.MoodId);
                        if (primaryMood?.Category == category)
                        {
                            result.Add(entry);
                        }
                    }
                }
            }
        }

        return result.OrderByDescending(e => e.EntryDate).ToList();
    }

    private string GetMoodCategoryClass(string category)
    {
        return category.ToLower() switch
        {
            "positive" => "mood-positive",
            "neutral" => "mood-neutral",
            "negative" => "mood-negative",
            _ => ""
        };
    }

    private string GetCategoryHeaderClass(string category)
    {
        return $"category-header-{category.ToLower()}";
    }

    private string GetBarColorClass(string category)
    {
        return $"bar-{category.ToLower()}";
    }

    private string GetCategoryIconClass(string category)
    {
        return category.ToLower() switch
        {
            "positive" => "bi bi-emoji-smile",
            "neutral" => "bi bi-emoji-neutral",
            "negative" => "bi bi-emoji-frown",
            _ => "bi bi-circle"
        };
    }
}